<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RedstoneReporter{% endblock %}</title>
    <link rel="icon" type="image/png" href="/static/img/redstone.png">

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/dark-mode.css">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Apply dark mode before body renders to avoid flash -->
    <script>
        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>

<body>
    <div class="app-layout">
        <!-- Mobile Hamburger Button -->
        <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle menu">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>

        <!-- Sidebar Backdrop (mobile) -->
        <div class="sidebar-backdrop" id="sidebar-backdrop" onclick="closeSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <span class="sidebar-brand">RedstoneReporter</span>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <div class="sidebar-section-title">Menu</div>

                <a href="/" class="sidebar-nav-item {% if active_page == 'dashboard' %}active{% endif %}">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 5a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 12a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1v-7z">
                        </path>
                    </svg>
                    Dashboard
                </a>

                <a href="/projects"
                    class="sidebar-nav-item {% if active_page in ['projects', 'project_detail', 'epic_detail', 'feature_detail', 'definition_detail', 'definition_form'] %}active{% endif %}">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    Projects
                </a>

                <!-- Contextual Sub-navigation -->
                {% if nav_project %}
                <div class="sidebar-subnav">
                    <a href="/projects/{{ nav_project.id }}"
                        class="sidebar-subnav-item {% if active_page == 'project_detail' and not nav_epic %}active{% endif %}">
                        {{ nav_project.name }}
                    </a>
                    {% if nav_epic %}
                    <a href="/projects/{{ nav_project.id }}/epics/{{ nav_epic.id }}"
                        class="sidebar-subnav-item {% if active_page == 'epic_detail' and not nav_feature %}active{% endif %}">
                        {{ nav_epic.name }}
                    </a>
                    {% endif %}
                    {% if nav_feature %}
                    <a href="/features/{{ nav_feature.id }}"
                        class="sidebar-subnav-item {% if active_page == 'feature_detail' and not nav_definition %}active{% endif %}">
                        {{ nav_feature.name }}
                    </a>
                    {% endif %}
                    {% if nav_definition %}
                    <a href="/test-cases/{{ nav_definition.id }}"
                        class="sidebar-subnav-item {% if active_page == 'definition_detail' or active_page == 'definition_form' %}active{% endif %}">
                        {{ nav_definition.title }}
                    </a>
                    {% endif %}
                </div>
                {% endif %}

                <a href="/docs" target="_blank" class="sidebar-nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    API Docs
                </a>
            </nav>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <!-- Moon icon (visible in light mode) -->
                    <svg id="theme-icon-moon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                        </path>
                    </svg>
                    <!-- Sun icon (visible in dark mode) -->
                    <svg id="theme-icon-sun" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="display:none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <span id="theme-label">Dark Theme</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <script>
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            var isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons();
        }

        function updateThemeIcons() {
            var isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon-moon').style.display = isDark ? 'none' : 'block';
            document.getElementById('theme-icon-sun').style.display = isDark ? 'block' : 'none';
            document.getElementById('theme-label').textContent = isDark ? 'Light Theme' : 'Dark Theme';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-backdrop').classList.toggle('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-backdrop').classList.remove('show');
        }

        // Close sidebar when a nav link is clicked (mobile)
        document.querySelectorAll('.sidebar-nav-item, .sidebar-subnav-item').forEach(function (link) {
            link.addEventListener('click', function () {
                if (window.innerWidth < 1024) {
                    closeSidebar();
                }
            });
        });

        // Set correct icon on page load
        updateThemeIcons();
    </script>
</body>

</html>